<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Котик готовит</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <style>
        /* Base Styles */
        :root {
            --primary-color: #6a0dad;
            --primary-dark: #450a63;
            --primary-light: #c6a3d0;
            --background-color: #2d013d;
            --text-color: #ffffff;
            --secondary-text: #cccccc;
            --border-radius: 12px;
            --container-width: 320px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 10px;
            text-align: center;
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }
        
        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: var(--container-width);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .header:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        .coins-display {
            font-size: 18px;
            display: flex;
            align-items: center;
            font-weight: bold;
        }
        
        .coins-display::before {
            content: "🪙";
            margin-right: 8px;
            font-size: 22px;
        }
        
        .header button {
            padding: 8px 15px;
            background-color: white;
            color: var(--primary-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .header button:hover {
            background-color: var(--primary-light);
            transform: scale(1.05);
        }
        
        .header button:active {
            transform: scale(0.95);
        }
        
        /* Cat Container Styles */
        #cat-container {
            margin: 15px auto;
            width: 100%;
            max-width: var(--container-width);
            padding: 15px;
            background-color: var(--primary-color);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        #cat-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        #cat {
            width: 100%;
            border-radius: 8px;
            transition: transform 0.5s ease;
        }
        
        .cat-cooking {
            animation: cooking 1s infinite alternate;
        }
        
        @keyframes cooking {
            0% { transform: rotate(-5deg); }
            100% { transform: rotate(5deg); }
        }
        
        /* Energy Bar Styles */
        .energy-bar-container {
            margin: 15px auto;
            width: 100%;
            max-width: var(--container-width);
            height: 60px;
            padding: 15px;
            background-color: var(--primary-color);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .energy-progress {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, #ff9900, #ffcc00);
            left: 0;
            top: 0;
            width: 100%;
            transition: width 0.5s ease;
            opacity: 0.7;
            z-index: 1;
        }
        
        .energy-bar-container span.energy-value {
            font-size: 20px;
            position: relative;
            z-index: 2;
            font-weight: bold;
            margin-left: 15px;
        }
        
        .energy-bar-container span.emoji {
            position: absolute;
            right: 15px;
            font-size: 24px;
            z-index: 2;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* Button Styles */
        button.main-action {
            padding: 15px 25px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 18px;
            cursor: pointer;
            margin: 15px 0;
            font-weight: bold;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            min-width: 250px;
        }
        
        button.main-action:hover:not(:disabled) {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        button.main-action:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        button.main-action:disabled {
            background-color: #8c59a3;
            cursor: not-allowed;
            opacity: 0.8;
        }
        
        /* Timer progress */
        .timer-progress {
            width: 100%;
            max-width: var(--container-width);
            height: 10px;
            background-color: var(--primary-light);
            border-radius: 5px;
            overflow: hidden;
            display: none;
            margin-top: 10px;
        }
        
        .timer-bar {
            height: 100%;
            width: 100%;
            background-color: var(--primary-color);
            transition: width 1s linear;
        }
        
        /* Instruction Styles */
        .instruction {
            font-size: 16px;
            color: var(--secondary-text);
            margin: 15px;
            max-width: var(--container-width);
            line-height: 1.4;
        }
        
        /* Overlay and Popup Styles */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .popup {
            background-color: #ffffff;
            color: var(--primary-color);
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .popup h2 {
            margin-top: 0;
            color: var(--primary-dark);
        }
        
        .popup p {
            font-size: 18px;
            margin: 15px 0;
        }
        
        .popup .dish-icon {
            font-size: 48px;
            margin: 10px 0;
            display: block;
        }
        
        .popup button {
            margin: 10px;
            padding: 12px 25px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            min-width: 120px;
        }
        
        .popup button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .popup button:active {
            transform: translateY(1px);
        }
        
        /* Navigation bar */
        .nav-container {
            width: 100%;
            max-width: var(--container-width);
            margin: 15px auto;
            background-color: var(--primary-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            display: flex;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .nav-item {
            flex: 1;
            padding: 12px 10px;
            color: white;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .nav-item.active {
            background-color: var(--primary-dark);
        }
        
        .nav-item:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .nav-text {
            font-size: 14px;
            font-weight: bold;
        }
        
        /* Pages */
        .page {
            display: none;
            width: 100%;
            max-width: var(--container-width);
        }
        
        .page.active {
            display: block;
        }
        
        /* Statistics */
        .stats-container {
            background-color: var(--primary-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .stats-title {
            color: white;
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .stat-item {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--secondary-text);
        }
        
        /* Withdraw form */
        .withdraw-form {
            background-color: var(--primary-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: none;
            background-color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            color: #333;
        }
        
        .form-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--primary-light);
        }
        
        .form-error {
            color: #ff6b6b;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        
        /* Energy recharge modal */
        .energy-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }
        
        .energy-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: #f0e6f5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .energy-option:hover {
            background-color: #e2d0eb;
            transform: translateX(5px);
        }
        
        .energy-amount {
            display: flex;
            align-items: center;
            font-weight: bold;
            color: var(--primary-dark);
        }
        
        .energy-amount::before {
            content: "⚡";
            margin-right: 5px;
        }
        
        .energy-ad-text {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1001;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        /* Responsive adjustments */
        @media (max-width: 400px) {
            :root {
                --container-width: 95%;
            }
            
            .header {
                padding: 10px 15px;
            }
            
            .header button {
                font-size: 12px;
                padding: 6px 10px;
            }
            
            .popup {
                width: 85%;
                padding: 15px;
            }
            
            .popup button {
                margin: 5px;
                padding: 8px 15px;
                min-width: 100px;
            }
            
            button.main-action {
                padding: 12px 20px;
                min-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <span id="coins" class="coins-display">0.00</span>
        <button id="watch-ad-button">Смотреть рекламу</button>
    </div>
    
    <div class="nav-container">
        <div class="nav-item active" data-page="cooking-page">
            <div class="nav-icon">👨‍🍳</div>
            <div class="nav-text">Готовка</div>
        </div>
        <div class="nav-item" data-page="withdraw-page">
            <div class="nav-icon">💸</div>
            <div class="nav-text">Вывод</div>
        </div>
    </div>
    
    <!-- Cooking Page -->
    <div id="cooking-page" class="page active">
        <div id="cat-container">
            <img id="cat" src="https://i.pinimg.com/originals/a8/14/62/a81462add55d387843fc80d4f21dd2b1.gif" alt="Котик" data-default="https://i.pinimg.com/originals/a8/14/62/a81462add55d387843fc80d4f21dd2b1.gif" data-cooking="https://i.pinimg.com/originals/0c/69/39/0c693901e2f64e84413b47922604dd88.gif" data-happy="https://i.pinimg.com/originals/9a/0a/79/9a0a79ccc8f123736059d67a86f0cfed.gif" data-tired="https://i.pinimg.com/originals/30/7a/59/307a59ee3120ee3c3216bb9dad8d4685.gif" data-selling="https://i.pinimg.com/originals/6b/1e/b7/6b1eb75915c0359234e21b6557120279.gif" data-eating="https://i.pinimg.com/originals/54/81/a8/5481a8795ae32a7dcce62cbacf4c9d1c.gif">
        </div>
        
        <div class="energy-bar-container">
            <div class="energy-progress" id="energy-progress"></div>
            <span class="energy-value" id="energy">100/100</span>
            <span class="emoji">⚡</span>
        </div>
        
        <button class="main-action" id="cook-button">Начать готовку (-25 энергии)</button>
        
        <div class="timer-progress" id="timer-progress">
            <div class="timer-bar" id="timer-bar"></div>
        </div>
        
        <p class="instruction">
            Нажмите "Начать готовку", чтобы получить одно из пяти блюд! Каждый сеанс готовки занимает 30 секунд и тратит 25 энергии.
        </p>
        
        <!-- Statistics -->
        <div class="stats-container">
            <h3 class="stats-title">Статистика</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="cooked-count">0</div>
                    <div class="stat-label">Приготовлено</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="eaten-count">0</div>
                    <div class="stat-label">Съедено</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="sold-count">0</div>
                    <div class="stat-label">Продано</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="ads-watched">0</div>
                    <div class="stat-label">Рекламы</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Withdraw Page -->
    <div id="withdraw-page" class="page">
        <div class="withdraw-form">
            <h3 class="stats-title">Вывод монет NEKOX</h3>
            
            <div class="form-group">
                <label class="form-label" for="solana-wallet">Solana кошелек:</label>
                <input type="text" id="solana-wallet" class="form-input" placeholder="Введите ваш Solana адрес">
                <div class="form-error" id="wallet-error">Неверный формат кошелька</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="withdraw-amount">Количество монет:</label>
                <input type="number" id="withdraw-amount" class="form-input" placeholder="Введите сумму для вывода" min="1">
                <div class="form-error" id="amount-error">Недостаточно монет на балансе</div>
            </div>
            
            <button class="main-action" id="withdraw-button">Вывести средства</button>
            
            <p class="instruction">
                Минимальная сумма для вывода: 10 NEKOX.<br>
                Вывод может занять до 24 часов.
            </p>
        </div>
    </div>

    <!-- Cooking result popup -->
    <div class="overlay" id="dish-overlay">
        <div class="popup">
            <h2>Блюдо готово!</h2>
            <span class="dish-icon" id="dish-icon">🍱</span>
            <p id="dish-result">Блюдо...</p>
            <div>
                <button id="sell-button">Продать</button>
                <button id="eat-button">Съесть</button>
            </div>
        </div>
    </div>
    
    <!-- Watch ad popup -->
    <div class="overlay" id="ad-overlay">
        <div class="popup">
            <h2>Посмотреть рекламу</h2>
            <p>Посмотрите рекламу и получите энергию:</p>
            <div class="energy-options">
                <div class="energy-option" data-energy="25" data-ad="1">
                    <span class="energy-amount">25</span>
                    <div>
                        <span>Короткая реклама</span>
                        <div class="energy-ad-text">15 секунд</div>
                    </div>
                </div>
                <div class="energy-option" data-energy="50" data-ad="1">
                    <span class="energy-amount">50</span>
                    <div>
                        <span>Средняя реклама</span>
                        <div class="energy-ad-text">30 секунд</div>
                    </div>
                </div>
                <div class="energy-option" data-energy="100" data-ad="1">
                    <span class="energy-amount">100</span>
                    <div>
                        <span>Полная реклама</span>
                        <div class="energy-ad-text">60 секунд</div>
                    </div>
                </div>
            </div>
            <button id="close-ad">Отмена</button>
        </div>
    </div>
    
    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBReHMQCQsPigKfmes_b2gr1lrv4eRjkMg",
            authDomain: "nekota-team.firebaseapp.com",
            databaseURL: "https://nekota-team-default-rtdb.firebaseio.com",
            projectId: "nekota-team",
            storageBucket: "nekota-team.firebasestorage.app",
            messagingSenderId: "489407578036",
            appId: "1:489407578036:web:ea764222bfec83f9aebce1"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // User Authentication
        let userId = null;
        
        // Game state
        const gameState = {
            energy: 100,
            coins: 0,
            stats: {
                cooked: 0,
                eaten: 0,
                sold: 0,
                adsWatched: 0
            },
            cookingActive: false
        };
        
        // Dishes data
        const dishes = [
            { name: "Яки-Маки", emoji: "🍣", chance: 1, price: 10, id: "yaki" },
            { name: "Масако-Суши", emoji: "🍱", chance: 3, price: 8, id: "masako" },
            { name: "Рики-Маки", emoji: "🍙", chance: 6, price: 5, id: "riki" },
            { name: "Тсуна-Суши", emoji: "🍘", chance: 10, price: 3, id: "tsuna" },
            { name: "Широ-Маки", emoji: "🍚", chance: 80, price: 1, id: "shiro" }
        ];
        
        // DOM Elements
        const cookButton = document.getElementById("cook-button");
        const energyDisplay = document.getElementById("energy");
        const energyProgress = document.getElementById("energy-progress");
        const coinsDisplay = document.getElementById("coins");
        const catImage = document.getElementById("cat");
        const dishOverlay = document.getElementById("dish-overlay");
        const adOverlay = document.getElementById("ad-overlay");
        const dishResult = document.getElementById("dish-result");
        const dishIcon = document.getElementById("dish-icon");
        const sellButton = document.getElementById("sell-button");
        const eatButton = document.getElementById("eat-button");
        const watchAdButton = document.getElementById("watch-ad-button");
        const closeAdButton = document.getElementById("close-ad");
        const timerProgress = document.getElementById("timer-progress");
        const timerBar = document.getElementById("timer-bar");
        const toast = document.getElementById("toast");
        const withdrawButton = document.getElementById("withdraw-button");
        const navItems = document.querySelectorAll(".nav-item");
        const pages = document.querySelectorAll(".page");
        
        // Stats elements
        const cookedCount = document.getElementById("cooked-count");
        const eatenCount = document.getElementById("eaten-count");
        const soldCount = document.getElementById("sold-count");
        const adsWatched = document.getElementById("ads-watched");
        
        // Get or create anonymous user
        function initUser() {
            return new Promise((resolve) => {
                firebase.auth().signInAnonymously()
                    .then((userCredential) => {
                        userId = userCredential.user.uid;
                        console.log("Authenticated anonymously with ID:", userId);
                        resolve(userId);
                    })
                    .catch((error) => {
                        console.error("Auth error:", error);
                        // Fallback to local storage if Firebase auth fails
                        userId = localStorage.getItem("userId") || `user_${Math.random().toString(36).substring(2, 15)}`;
                        localStorage.setItem("userId", userId);
                        resolve(userId);
                    });
            });
        }

        // Initialize game
        async function initGame() {
            updateEnergy();
            updateCoins();
            updateStats();
            
            // Get user ID
            await initUser();
            
            // Try to load data from Firebase
            loadUserData();
        }
        
        // Load user data from Firebase
        function loadUserData() {
            if (!userId) {
                console.error("No user ID available");
                return;
            }
            
            database.ref(`users/${userId}`).once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // Load game state from Firebase
                        gameState.coins = data.coins || 0;
                        gameState.energy = data.energy || 100;
                        gameState.stats = data.stats || {
                            cooked: 0,
                            eaten: 0,
                            sold: 0,
                            adsWatched: 0
                        };
                        
                        // Update UI
                        updateEnergy();
                        updateCoins();
                        updateStats();
                        
                        console.log("Loaded user data from Firebase");
                    } else {
                        // If no data in Firebase, try local storage as fallback
                        const savedState = localStorage.getItem("catCookingGame");
                        if (savedState) {
                            try {
                                const parsed = JSON.parse(savedState);
                                gameState.coins = parsed.coins || 0;
                                gameState.energy = parsed.energy || 100;
                                gameState.stats = parsed.stats || {
                                    cooked: 0,
                                    eaten: 0,
                                    sold: 0,
                                    adsWatched: 0
                                };
                                updateEnergy();
                                updateCoins();
                                updateStats();
                                
                                // Save to Firebase
                                saveGame();
                            } catch (e) {
                                console.error("Error loading saved game:", e);
                            }
                        }
                    }
                })
                .catch((error) => {
                    console.error("Error loading user data:", error);
                    // Fallback to local storage
                    const savedState = localStorage.getItem("catCookingGame");
                    if (savedState) {
                        try {
                            const parsed = JSON.parse(savedState);
                            gameState.coins = parsed.coins || 0;
                            gameState.energy = parsed.energy || 100;
                            gameState.stats = parsed.stats || {
                                cooked: 0,
                                eaten: 0,
                                sold: 0,
                                adsWatched: 0
                            };
                            updateEnergy();
                            updateCoins();
                            updateStats();
                        } catch (e) {
                            console.error("Error loading saved game:", e);
                        }
                    }
                });
        }
        
        // Save game state
        function saveGame() {
            // Save to Firebase
            if (userId) {
                const userData = {
                    coins: gameState.coins,
                    energy: gameState.energy,
                    stats: gameState.stats,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                };
                
                database.ref(`users/${userId}`).update(userData)
                    .then(() => {
                        console.log("User data saved to Firebase");
                    })
                    .catch((error) => {
                        console.error("Error saving to Firebase:", error);
                        // Fallback to local storage
                        localStorage.setItem("catCookingGame", JSON.stringify({
                            coins: gameState.coins,
                            energy: gameState.energy,
                            stats: gameState.stats
                        }));
                    });
            } else {
                // Fallback to local storage
                localStorage.setItem("catCookingGame", JSON.stringify({
                    coins: gameState.coins,
                    energy: gameState.energy,
                    stats: gameState.stats
                }));
            }
        }
        
        // Update energy display
        function updateEnergy() {
            energyDisplay.textContent = `${gameState.energy}/100`;
            const energyPercent = gameState.energy;
            energyProgress.style.width = `${energyPercent}%`;
            
            // Update cook button state
            cookButton.disabled = gameState.energy < 25 || gameState.cookingActive;
        }
        
        // Update coins display
        function updateCoins() {
            coinsDisplay.textContent = gameState.coins.toFixed(2);
        }
        
        // Update statistics
        function updateStats() {
            cookedCount.textContent = gameState.stats.cooked;
            eatenCount.textContent = gameState.stats.eaten;
            soldCount.textContent = gameState.stats.sold;
            adsWatched.textContent = gameState.stats.adsWatched;
        }
        
        // Show toast notification
        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.classList.add("show");
            setTimeout(() => {
                toast.classList.remove("show");
            }, duration);
        }
        
        // Get random dish based on chances
        function getRandomDish() {
            const random = Math.random() * 100;
            let cumulativeChance = 0;
            for (const dish of dishes) {
                cumulativeChance += dish.chance;
                if (random <= cumulativeChance) {
                    return dish;
                }
            }
            return dishes[dishes.length - 1];
        }
        
        // Start cooking timer
        function startCooking() {
            const cookingDuration = 30; // seconds
            gameState.energy -= 25;
            gameState.cookingActive = true;
            
            updateEnergy();
            saveGame();
            
            // Show timer and update button text
            timerProgress.style.display = "block";
            cookButton.textContent = `Готовка... ${cookingDuration} сек.`;
            cookButton.disabled = true;
            
            // Start cat animation
            catImage.classList.add("cat-cooking");
            
            // Timer animation
            timerBar.style.width = "100%";
            setTimeout(() => {
                timerBar.style.width = "0%";
            }, 50);
            
            // Countdown
            let timeLeft = cookingDuration;
            const interval = setInterval(() => {
                timeLeft--;
                cookButton.textContent = `Готовка... ${timeLeft} сек.`;
                
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    finishCooking();
                }
            }, 1000);
        }
        
        // Finish cooking and show result
        function finishCooking() {
            // Reset UI
            timerProgress.style.display = "none";
            cookButton.textContent = "Начать готовку (-25 энергии)";
            catImage.classList.remove("cat-cooking");
            gameState.cookingActive = false;
            updateEnergy();
            
            // Get random dish and update stats
            const dish = getRandomDish();
            gameState.stats.cooked++;
            updateStats();
            saveGame();
            
            // Show result popup
            dishIcon.textContent = dish.emoji;
            dishResult.textContent = `Вам выпало: ${dish.name}! Цена: ${dish.price} NEKOX`;
            showOverlay(dishOverlay);
            
            // Setup buttons
            sellButton.onclick = () => {
                sellDish(dish);
            };
            
            eatButton.onclick = () => {
                eatDish(dish);
            };
        }
        
        // Sell dish
        function sellDish(dish) {
            gameState.coins += dish.price;
            gameState.stats.sold++;
            updateCoins();
            updateStats();
            saveGame();
            
            showToast(`Вы продали ${dish.name} за ${dish.price} NEKOX!`);
            hideOverlay(dishOverlay);
        }
        
        // Eat dish
        function eatDish(dish) {
            const energyGain = dish.price * 5;
            gameState.energy = Math.min(100, gameState.energy + energyGain);
            gameState.stats.eaten++;
            updateEnergy();
            updateStats();
            saveGame();
            
            showToast(`Вы съели ${dish.name} и восстановили ${energyGain} энергии!`);
            hideOverlay(dishOverlay);
        }
        
        // Simulate watching an ad and get energy
        function watchAd(energyAmount) {
            const adDuration = energyAmount === 25 ? 5 : (energyAmount === 50 ? 10 : 15); // For simulation
            
            cookButton.disabled = true;
            watchAdButton.disabled = true;
            showToast(`Просмотр рекламы (${adDuration} сек)...`);
            
            setTimeout(() => {
                gameState.energy = Math.min(100, gameState.energy + energyAmount);
                gameState.stats.adsWatched++;
                updateEnergy();
                updateStats();
                saveGame();
                
                cookButton.disabled = gameState.energy < 25;
                watchAdButton.disabled = false;
                showToast(`Вы получили ${energyAmount} энергии за просмотр рекламы!`);
            }, adDuration * 1000);
        }
        
        // Show overlay with animation
        function showOverlay(overlay) {
            overlay.style.display = "flex";
            setTimeout(() => {
                overlay.style.opacity = "1";
                overlay.querySelector(".popup").style.transform = "scale(1)";
            }, 10);
        }
        
        // Hide overlay with animation
        function hideOverlay(overlay) {
            overlay.style.opacity = "0";
            overlay.querySelector(".popup").style.transform = "scale(0.9)";
            setTimeout(() => {
                overlay.style.display = "none";
            }, 300);
        }
        
        // Process withdrawal
        function processWithdrawal() {
            const walletInput = document.getElementById("solana-wallet");
            const amountInput = document.getElementById("withdraw-amount");
            const walletError = document.getElementById("wallet-error");
            const amountError = document.getElementById("amount-error");
            
            // Reset errors
            walletError.style.display = "none";
            amountError.style.display = "none";
            
            const wallet = walletInput.value.trim();
            const amount = parseFloat(amountInput.value);
            
            // Validate wallet (simple validation)
            if (!wallet || !wallet.startsWith("sol")) {
                walletError.style.display = "block";
                return;
            }
            
            // Validate amount
            if (isNaN(amount) || amount < 10) {
                amountError.textContent = "Минимальная сумма: 10 NEKOX";
                amountError.style.display = "block";
                return;
            }
            
            if (amount > gameState.coins) {
                amountError.textContent = "Недостаточно монет на балансе";
                amountError.style.display = "block";
                return;
            }
            
            // Save withdrawal request to Firebase
            if (userId) {
                const withdrawalData = {
                    userId: userId,
                    wallet: wallet,
                    amount: amount,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'pending'
                };
                
                // Push withdrawal request to withdrawals collection
                database.ref('withdrawals').push(withdrawalData)
                    .then((response) => {
                        console.log("Withdrawal request saved with ID:", response.key);
                        
                        // Update user's coin balance
                        gameState.coins -= amount;
                        updateCoins();
                        saveGame();
                        
                        // Reset form
                        walletInput.value = "";
                        amountInput.value = "";
                        
                        showToast(`Запрос на вывод ${amount} NEKOX отправлен!`, 5000);
                    })
                    .catch((error) => {
                        console.error("Error saving withdrawal request:", error);
                        showToast("Ошибка при отправке запроса. Попробуйте позже.", 5000);
                    });
            } else {
                // If no Firebase connection, just simulate
                gameState.coins -= amount;
                updateCoins();
                saveGame();
                
                // Reset form
                walletInput.value = "";
                amountInput.value = "";
                
                showToast(`Запрос на вывод ${amount} NEKOX отправлен!`, 5000);
            }
        }
        
        // Handle navigation
        function setupNavigation() {
            navItems.forEach(item => {
                item.addEventListener("click", () => {
                    // Update active state for nav items
                    navItems.forEach(nav => nav.classList.remove("active"));
                    item.classList.add("active");
                    
                    // Show corresponding page
                    const targetPage = item.getAttribute("data-page");
                    pages.forEach(page => {
                        page.classList.remove("active");
                        if (page.id === targetPage) {
                            page.classList.add("active");
                        }
                    });
                });
            });
        }
        
        // Event Listeners
        document.addEventListener("DOMContentLoaded", () => {
            // Initialize game
            initGame();
            setupNavigation();
            
            // Cook button
            cookButton.addEventListener("click", () => {
                if (gameState.energy >= 25 && !gameState.cookingActive) {
                    startCooking();
                } else if (gameState.energy < 25) {
                    showToast("Недостаточно энергии! Посмотрите рекламу или съешьте блюдо.");
                }
            });
            
            // Watch ad button
            watchAdButton.addEventListener("click", () => {
                showOverlay(adOverlay);
            });
            
            // Close ad overlay
            closeAdButton.addEventListener("click", () => {
                hideOverlay(adOverlay);
            });
            
            // Energy options
            document.querySelectorAll(".energy-option").forEach(option => {
                option.addEventListener("click", () => {
                    const energy = parseInt(option.getAttribute("data-energy"));
                    hideOverlay(adOverlay);
                    watchAd(energy);
                });
            });
            
            // Withdraw button
            withdrawButton.addEventListener("click", processWithdrawal);
            
            // Save game every minute
            setInterval(saveGame, 60000);
        });
    </script>
</body>
</html>